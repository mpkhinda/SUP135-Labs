---
title: 'HKS SUP-135 Project Part 2: Stories from the Opportunity Atlas'
author: "Matt Khinda"
date: "4/8/2023"
output: pdf_document
---

```{r setup, include=FALSE}
# Settings for PDF output
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE) 
knitr::opts_chunk$set(fig.width=12, fig.height=7, fig.align = "center") 

# Require packages and install and load if not already
if (!require(haven)) install.packages("haven"); library(haven)
if (!require(tidyverse)) install.packages("tidyverse"); library(tidyverse)
if (!require(ggplot2)) install.packages("ggplot2"); library(ggplot2)
if (!require(statar)) install.packages("statar"); library(statar)
if (!require(here)) install.packages("here"); library(here)
if (!require(htmltools)) install.packages("htmltools"); library(htmltools)
if (!require(sandwich)) install.packages("sandwich"); library(sandwich)
if (!require(lmtest)) install.packages("lmtest"); library(lmtest)
if (!require(sf)) install.packages("sf"); library(sf)
if (!require(ggspatial)) install.packages("ggspatial"); library(ggspatial)
if (!require(geojsonsf)) install.packages("geojsonsf"); library(geojsonsf)

# Clear workspace
rm(list=ls())
cat('\014')
```

```{r load data, include=FALSE}
atlas <- read_dta(here("datasets", "atlas.dta"))
streets <- read_sf(here("datasets", "Street_Centerlines_1999/Street_Centerlines_1999.shp"))
nodes <- read_sf(here("datasets", "Street_Centerlines_1999/Street_Nodes_1999.shp")) %>%
  select(OBJECTID) # removes all extraneous info
tract_geom <- read_sf(here("datasets", "Census_Tracts_in_2010/Census_Tracts_in_2010.shp")) %>%
  select(GEOID, geometry)
```

```{r map test}
# test plot to check that streets, nodes, and tracts are using the same coordinate projection system
ggplot()+
  geom_sf(data = tract_geom) +
  geom_sf(data = streets,  alpha = 0.5) +
  geom_sf(data = nodes, alpha = 0.5, size = 0.65) +
  theme_void()
```

```{r calc node degree}

# Example of loop assigning node degree
nodes_example <- nodes %>%
  subset(OBJECTID < 6) # limit example to first five nodes

for (i in seq(1, 5, 1)){
  # get list of binary variables for all road segments indicating if the segment touches the node
  touch_list <- st_touches(streets,nodes %>% subset(OBJECTID == i)) 
  # sum up count of 1s for roads that touch the node to obtain the node degree
  nodes_example$node_degree[i] <- sum(unlist(touch_list)) 
}


# DO NOT RE-RUN, TAKES 3+ HOURS! SEE ABOVE FOR DEMONSTRATION

# calculate avg nodal degree for each node in network 
  #for (i in seq(1, nrow(nodes), 1)){
    #touch_list <- st_touches(streets,nodes %>% subset(OBJECTID == i))
    #nodes$node_degree[i] <- sum(unlist(touch_list))
    
    # print progress
    #cat(paste0(round(i / nrow(nodes) * 100), '% completed'))
    #Sys.sleep(.5)
    #if (i == nrow(nodes)) cat(': Done')
    #else cat('\014')
  #}

# write data to geojson to avoid needing to re-run above loop in the future
  #st_write(nodes,here("datasets", "nodes_w_degree.geojson"))


# Replaces current dataframe with already prepared data including node degree
nodes <- geojson_sf(here("datasets", "nodes_w_degree.geojson"))

```

```{r group nodes by tract}

# assign each node to the tract it sits within and roll up by GEOID and calculate average node degree
tracts_w_node_degree <- st_join(tract_geom, nodes, join = st_contains) %>%
  group_by(GEOID) %>%
  summarise(avg_node_degree = mean(node_degree))

# test plot to visualize average node degree by tract
ggplot()+
  geom_sf(data = tracts_w_node_degree, aes(fill = avg_node_degree), color = NA) +
  geom_sf(data = streets,  alpha = 0.5) +
  theme_void()
```

```{r join data to atlas}
# filter atlas data for DC only
DC_atlas <- subset(atlas, state == 11) 

# create new tract variable from full FIPS code and remove leading 0s to match atlas
tracts_w_node_degree <- tracts_w_node_degree %>%
  mutate(tract = sub("^0+", "", substr(GEOID, nchar(GEOID)-5, nchar(GEOID)))) %>%
  mutate(tract = as.numeric(tract))

# join average node degree value to atlas data by GEOID
DC_atlas <- left_join(DC_atlas, tracts_w_node_degree) %>%
  select(!c(GEOID, geometry))
```

```{r correlation test plot}
ggplot(data = DC_atlas, aes(x = avg_node_degree , y = kfr_pooled_pooled_p25)) + 
  geom_point(size = 1) + 
  geom_text(aes(label=tract), size=2.5, nudge_y = -.2) +
  labs(title = "Street Grid Connectedness vs. Mean Income Percentile Rank for Children of Low-Income Parents in Washington, DC", x = "Average Node Degree", y = "Mean Income Percentile Rank") +
  stat_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  theme(plot.title = element_text(size=18,hjust = 0.5))
```

```{r linear model}
univariate_model <- lm(kfr_pooled_pooled_p25 ~ avg_node_degree, data = DC_atlas)
summary(univariate_model)
```











