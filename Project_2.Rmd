---
title: 'HKS SUP-135 Project Part 2: Stories from the Opportunity Atlas'
author: "Matt Khinda"
date: "4/8/2023"
output: pdf_document
---

```{r setup, include=FALSE}
# Settings for PDF output
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE) 
knitr::opts_chunk$set(fig.width=12, fig.height=7, fig.align = "center") 

# Require packages and install and load if not already
if (!require(haven)) install.packages("haven"); library(haven)
if (!require(tidyverse)) install.packages("tidyverse"); library(tidyverse)
if (!require(ggplot2)) install.packages("ggplot2"); library(ggplot2)
if (!require(statar)) install.packages("statar"); library(statar)
if (!require(here)) install.packages("here"); library(here)
if (!require(htmltools)) install.packages("htmltools"); library(htmltools)
if (!require(sandwich)) install.packages("sandwich"); library(sandwich)
if (!require(lmtest)) install.packages("lmtest"); library(lmtest)
if (!require(sf)) install.packages("sf"); library(sf)
if (!require(ggspatial)) install.packages("ggspatial"); library(ggspatial)

# Clear workspace
rm(list=ls())
cat('\014')
```

```{r load data, include=FALSE}
atlas <- read_dta(here("datasets", "atlas.dta"))
streets <- read_sf(here("datasets", "Street_Centerlines_1999/Street_Centerlines_1999.shp"))
tract_geom <- read_sf(here("datasets", "Census_Tracts_in_2010/Census_Tracts_in_2010.shp")) %>%
  select(GEOID, geometry)
```

```{r map test}
# test plot to check that streets and tracts are using 
# the same coordinate projection system
ggplot()+
  geom_sf(data = tract_geom) +
  geom_sf(data = streets,  alpha = 0.5) +
  theme_void()
```
```{r create simplified segments}
#simplify topology to line from start and end nodes only
get_start_end <- function(line){
  to_points <- st_cast(line$geometry, "POINT")
  start <- to_points[1]
  end <- to_points[length(to_points)]
  
  return(data.frame(name = line$ST_NAME, 
                    start_lon = unlist(start)[1], 
                    start_lat = unlist(start)[2], 
                    end_lon = unlist(end)[1], 
                    end_lat = unlist(end)[2], 
                    geometry = st_cast(st_union(start,end),"LINESTRING")))
}

# test function on single segment
test_run <- streets %>%
  subset(OBJECTID == 5) %>%
  get_start_end() %>%
  st_as_sf()


# loop through all segments and apply function (Takes 18 mins)
simplified_streets <- data.frame()

for (i in seq(1,nrow(streets),1)){
  temp_segment <- streets %>%
    subset(OBJECTID == i) %>%
    get_start_end() %>%
    st_as_sf()
  
  simplified_streets <- rbind(simplified_streets, temp_segment)
}

# filter out points with no length
simplified_streets <- simplified_streets %>% 
  filter(start_lon != end_lon)

  
# test plot to see simplified network
ggplot()+
  geom_sf(data = streets, alpha = 0.2) +
  geom_sf(data = simplified_streets, color = "red") +
  geom_sf(data = tract_geom, fill = NA) +
  theme_void()

```


```{r select segments by tract}

# extract list of geoids
GEOID_list <- tract_geom %>%
  st_drop_geometry()

# create dataframes for each GEOID with clipped roads
for (i in seq(1,nrow(tract_geom),1)){
  assign(paste("streets_tract_", GEOID_list$GEOID[i], sep =""), 
         tract_geom %>%
         subset(GEOID == GEOID_list$GEOID[i]) %>%
         st_intersection(simplified_streets))
}


# test plot to see clipped simplified network
ggplot()+
  geom_sf(data = streets, alpha = 0.2) +
  geom_sf(data = streets_tract_11001009503, color = "red") +
  geom_sf(data = tract_geom, fill = NA) +
  theme_void()
```


```{r calc street bearings}



```


```{r determine tract street entropy}



```


